import board
import wifi
import os
import time
import gc
import terminalio
import displayio
import rgbmatrix
import framebufferio
import adafruit_requests
import adafruit_connection_manager
from adafruit_display_text import label

# --- 1. HARDWARE SETUP ---
displayio.release_displays()
matrix_bus = rgbmatrix.RGBMatrix(
    width=64, height=32, bit_depth=1,
    rgb_pins=[board.MTX_R1, board.MTX_G1, board.MTX_B1, board.MTX_R2, board.MTX_G2, board.MTX_B2],
    addr_pins=[board.MTX_ADDRA, board.MTX_ADDRB, board.MTX_ADDRC, board.MTX_ADDRD],
    clock_pin=board.MTX_CLK, latch_pin=board.MTX_LAT, output_enable_pin=board.MTX_OE
)
display = framebufferio.FramebufferDisplay(matrix_bus, auto_refresh=True)
main_group = displayio.Group()
display.root_group = main_group

# Colors
CBJ_BLUE, GOLD, WHITE, GREEN = 0x002654, 0xFFD700, 0xFFFFFF, 0x00FF00

top_lbl = label.Label(terminalio.FONT, text="CBJ", color=WHITE, x=2, y=8)
bot_lbl = label.Label(terminalio.FONT, text="INIT...", color=WHITE, x=2, y=22)
main_group.append(top_lbl)
main_group.append(bot_lbl)

# --- 2. NETWORK ---
wifi.radio.connect(os.getenv("CIRCUITPY_WIFI_SSID"), os.getenv("CIRCUITPY_WIFI_PASSWORD"))
pool = adafruit_connection_manager.get_radio_socketpool(wifi.radio)
ssl_ctx = adafruit_connection_manager.get_radio_ssl_context(wifi.radio)
requests = adafruit_requests.Session(pool, ssl_ctx)

PROXY_URL = "PUT THE URL FOR YOUR WORKER HERE!!/"

def scroll_text(text, color):
    bot_lbl.text = text
    bot_lbl.color = color
    text_width = len(text) * 6
    for x in range(64, -text_width, -1):
        bot_lbl.x = x
        time.sleep(0.04)
    bot_lbl.x = 2 

# --- 3. MAIN LOOP ---
while True:
    try:
        gc.collect()
        with requests.get(PROXY_URL, timeout=10) as resp:
            # THE FIX: Clean the incoming text of any quotes or brackets
            raw_data = resp.text
            clean_data = raw_data.replace('"', '').replace('{', '').replace('}', '')
            
            # Screen 1: Status
            top_lbl.text, top_lbl.color = "OLYMPIC", GOLD
            bot_lbl.text, bot_lbl.color = "BREAK", WHITE
            time.sleep(10)
            
            # Screen 2: Scrolling Proxy Data
            top_lbl.text, top_lbl.color = "METRO STANDINGS", GREEN
            scroll_text(clean_data, WHITE)
            
    except Exception as e:
        print(f"Proxy Error: {e}")
        bot_lbl.text = "RETRY"
        time.sleep(5)
